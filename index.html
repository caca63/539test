<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>å°ç£ 539 AI æ©Ÿç‡åˆ†æå™¨ v3</title>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  margin:0;
  padding:16px;
}
.card{
  background:#111827cc;
  padding:14px;
  border-radius:16px;
  margin-bottom:12px;
  box-shadow:0 10px 25px rgba(15,23,42,.6);
}
.btn{
  padding:8px 12px;
  border-radius:999px;
  border:0;
  background:linear-gradient(135deg,#22d3ee,#60a5fa);
  color:#020617;
  font-weight:700;
  cursor:pointer;
}
.btn.sec{
  background:#020617;
  color:#e5e7eb;
  border:1px solid rgba(148,163,184,.25);
}
input,textarea,select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.25);
  background:#020617;
  color:#e5e7eb;
}
.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
.split2{
  display:flex;
  gap:10px;
}
.split2>div{flex:1;}

.chip{
  background:#1e293b;
  border-radius:12px;
  padding:6px 8px;
  font-size:13px;
  border:1px solid rgba(148,163,184,.35);
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}
.chip.rankTop{
  border-color:#38bdf8;
  background:radial-gradient(circle at top,#0ea5e944,#020617);
}
.chartBox{
  width:100%;
  height:320px;
  background:#0b1120;
  border-radius:12px;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>å°ç£ 539 AI æ©Ÿç‡åˆ†æå™¨ v3</h1>

<div id="stats" style="margin-bottom:8px;color:#60a5fa"></div>

<!-- r è¡°æ¸› + è¨­å®š -->
<div class="card">
  <label>è¡°æ¸›æ¬Šé‡ r</label>
  <div class="row">
    <input id="r" type="number" step="0.01" min="0" max="1" value="0.8" style="max-width:100px">
    <button class="btn sec" onclick="setR(0.6)">r=0.6</button>
    <button class="btn sec" onclick="setR(0.8)">r=0.8</button>
    <button class="btn sec" onclick="setR(0.95)">r=0.95</button>
  </div>

  <div class="row">
    <label><input type="checkbox" id="streak" checked> ğŸ” ç†±è™Ÿé€£é–‹æ‡²ç½°</label>
    <label><input type="checkbox" id="avoid" checked> é¿å…é‡è¤‡ä¸Šä¸€æœŸ</label>
    <label><input type="checkbox" id="useAI" checked> ğŸ¤– ä½¿ç”¨ AIï¼ˆMarkov + TensorFlowï¼‰</label>
  </div>
</div>

<!-- æ–°å¢æœŸæ•¸ -->
<div class="card">
  <label>æ–°å¢æœ€æ–°ä¸€æœŸï¼ˆäº”é¡†ï¼‰</label>
  <input id="latest" placeholder="ä¾‹å¦‚ï¼š3 11 22 27 38">
  <div class="row">
    <button class="btn" onclick="appendLatest()">åŠ å…¥åˆ°æ­·å²</button>
    <button class="btn sec" onclick="clearAdded()">é‡ç½®æœ¬æ©Ÿæ–°å¢</button>
  </div>
</div>

<!-- å–®è™Ÿ AI æ©Ÿç‡ï¼ˆæ’åºï¼‰ -->
<div class="card">
  <h3>ğŸ”¢ å–®è™Ÿ AI æ©Ÿç‡ï¼ˆä¾æ¬Šé‡æ’åºï¼‰</h3>
  <div id="singleTop" class="split2" style="margin-top:6px;font-size:13px;color:#9ca3af">
    å°šæœªè¨ˆç®—
  </div>
</div>

<!-- Top10 -->
<div class="card">
  <h3>ğŸ’¡ æ¨è–¦çµ„åˆ Top10ï¼ˆAI + WebWorkerï¼‰</h3>
  <div id="toplist" class="split2"></div>

  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="run()">ğŸ”¥ è¨ˆç®— AI é æ¸¬</button>
  </div>
</div>

<div class="card">
  <h3>ğŸ¤– ç”¢ç”Ÿ AI æ¨¡å‹ï¼ˆmodel.json + weights.binï¼‰</h3>
  <button class="btn" onclick="generateModelFiles()">
    ç”¢ç”Ÿ AI æ¨¡å‹ï¼ˆGlorot åˆå§‹åŒ–ï¼‰
  </button>
  <div style="font-size:12px;color:#94a3b8;margin-top:6px;">
    æŒ‰ä¸‹å¾Œï¼Œç€è¦½å™¨æœƒè‡ªå‹•ä¸‹è¼‰ model.json èˆ‡ weights.binã€‚
  </div>
</div>

<!-- æˆ‘çš„ä¸‹æ³¨ -->
<div class="card">
  <h3>æˆ‘çš„ä¸‹æ³¨çµæœ</h3>
  <textarea id="bets" placeholder="ä¾‹å¦‚ï¼š1 12 23 28 35"></textarea>
  <div id="myres" style="white-space:pre-wrap;margin-top:10px;color:#94a3b8">å°šæœªè¨ˆç®—</div>
</div>

<!-- åœ–è¡¨ -->
<div class="card">
  <h3>ğŸ“ˆ é€£èŠèµ°å‹¢åœ–ï¼ˆèˆ‡å‰ä¸€æœŸé‡è¤‡çš„è™Ÿç¢¼æ•¸ï¼‰</h3>
  <canvas id="streakChart" height="180"></canvas>
</div>

<div class="card">
  <h3>ğŸ“Š å„è™Ÿç¢¼å‡ºç¾æ¬¡æ•¸çµ±è¨ˆï¼ˆ1~39ï¼‰</h3>
  <canvas id="countChart" height="220"></canvas>
</div>

<!-- å›æ¸¬ -->
<div class="card">
  <h3>ğŸ“ˆ å›æ¸¬ï¼ˆTop5ï¼‰</h3>
  <div id="hitSummary" style="margin-bottom:8px;color:#94a3b8">å°šæœªå›æ¸¬</div>
  <table style="width:100%;font-size:12px;border-collapse:collapse;">
    <thead>
      <tr style="color:#bfdbfe">
        <th>æœŸæ•¸</th><th>é–‹ç</th><th>æœ€ä½³</th><th>å‘½ä¸­çµ„åˆ</th>
      </tr>
    </thead>
    <tbody id="hitTable"></tbody>
  </table>
</div>

<script src="issueDate.js"></script>
<script src="fetchData.js"></script>
<script src="ai.js"></script>
<script src="charts.js"></script>

<script>
// ------------------ Data ----------------------
const LS_KEY="extra539_v3";
let added=JSON.parse(localStorage.getItem(LS_KEY)||"[]");

// base historyï¼ˆæœƒç”¨ fetchData.js è‡ªå‹•è¦†è“‹ï¼‰
let baseHistory=[
  [3,11,22,27,38],
  [5,9,12,19,33],
  [7,11,20,25,36]
];

function getAll(){ return baseHistory.concat(added); }

function updateStats(){
  const all=getAll();
  const latest=all[all.length-1]||[];
  document.getElementById("stats").innerHTML=
    `ğŸ“Š æ­·å²æœŸæ•¸ï¼š${all.length}ã€€æœ€æ–°ï¼š${latest.join(" ")}`;
}
updateStats();

function appendLatest(){
  const v=latest.value.trim().split(/\s+/).map(Number);
  if(v.length===5 && v.every(n=>n>=1&&n<=39)){
    added.push(v);
    localStorage.setItem(LS_KEY,JSON.stringify(added));
    updateStats();
    latest.value="";
  }else alert("äº”é¡† 1~39");
}
function clearAdded(){
  if(confirm("æ¸…é™¤æœ¬æ©Ÿæ–°å¢ï¼Ÿ")){
    added=[];
    localStorage.removeItem(LS_KEY);
    updateStats();
  }
}
function setR(v){document.getElementById("r").value=v;}


// ------------------ WebWorker ----------------------
const worker=new Worker("worker.js");
let workerReady=false;

worker.onmessage=function(e){
  const msg=e.data;

  if(msg.type==="ready"){
    workerReady=true;
    return;
  }
  if(msg.type==="top10"){
    renderTop10(msg.data);
    return;
  }
};

function computeTop10(probs,last,avoid,streak){
  if(!workerReady){
    alert("Worker å°šæœªè¼‰å…¥å®Œç•¢ï¼");
    return;
  }
  worker.postMessage({
    type:"computeTop10",
    probs,last,avoid,streak
  });
}


// ------------------ å–®è™Ÿæ’åº ----------------------
function updateSingleTop(probs){
  const arr=probs.map((p,i)=>({num:i+1,p})).sort((a,b)=>b.p-a.p);

  const left=arr.slice(0,20);
  const right=arr.slice(20);

  singleTop.innerHTML=`
    <div>${left.map(o=>`<div class="chip"><span>${o.num}</span><span>${(o.p*100).toFixed(3)}%</span></div>`).join("")}</div>
    <div>${right.map(o=>`<div class="chip"><span>${o.num}</span><span>${(o.p*100).toFixed(3)}%</span></div>`).join("")}</div>
  `;
}


// ------------------ Top10 ----------------------
function renderTop10(list){
  const left=list.slice(0,5);
  const right=list.slice(5);

  toplist.innerHTML=`
    <div>${left.map((o,i)=>`
      <div class="chip rankTop">
        <span>Top${i+1}ï½œ${o.t.join(" ")}</span>
        <span>${(o.score*100).toFixed(6)}%</span>
      </div>`).join("")}</div>

    <div>${right.map((o,i)=>`
      <div class="chip">
        <span>Top${i+6}ï½œ${o.t.join(" ")}</span>
        <span>${(o.score*100).toFixed(6)}%</span>
      </div>`).join("")}</div>
  `;
}


// ------------------ å›æ¸¬ ----------------------
function backtest(all){
  const rows=[];
  for(let i=1;i<all.length-1;i++){
    const train=all.slice(0,i+1);
    const target=all[i+1];

    const probs=window.AI_finalProb(train);

    const last=train[train.length-1];
    const streak=document.getElementById("streak").checked;
    const avoid=document.getElementById("avoid").checked;

    // å– Top5
    const top5=window.AI_localComputeTop5(probs,last,avoid,streak);

    let best=0;
    const hitList=[];
    for(const t of top5){
      const hit=t.t.filter(x=>target.includes(x)).length;
      if(hit>0) hitList.push({t:t.t,hit});
      best=Math.max(best,hit);
    }
    rows.push({issue:i+1,target,best,hitList});
  }
  return rows;
}

function renderHits(rows){
  let html="";
  let c1=0,c2=0,c3=0,c4=0,c5=0;

  for(const r of rows){
    if(r.best===1)c1++;
    if(r.best===2)c2++;
    if(r.best===3)c3++;
    if(r.best===4)c4++;
    if(r.best===5)c5++;

    html+=`
      <tr>
        <td>${r.issue}</td>
        <td>${r.target.join(" ")}</td>
        <td>${r.best}</td>
        <td>${r.hitList.map(x=>`${x.t.join(" ")}(${x.hit})`).join("ã€") || "-"}</td>
      </tr>`;
  }
  hitTable.innerHTML=html;

  hitSummary.innerHTML=
    `è‡³å°‘ä¸­ 1 é¡†ï¼š${c1+c2+c3+c4+c5} æœŸï¼ˆå«å…¨ä¸­ ${c5} æœŸï¼‰`;
}


// ------------------ ä¸»æµç¨‹ ----------------------
async function run(){
  const all=getAll();

  // 1. è¨ˆç®—å–®è™Ÿ AI æ©Ÿç‡
  const probs=await AI_finalProb(all);
  updateSingleTop(probs);

  // 2. Worker è¨ˆç®— Top10
  computeTop10(
    probs,
    all[all.length-1],
    document.getElementById("avoid").checked,
    document.getElementById("streak").checked
  );

  // 3. æˆ‘çš„ä¸‹æ³¨
  const betLines=bets.value.trim().split(/\n+/);
  const out=[];
  for(const line of betLines){
    const t=line.split(/\s+/).map(Number);
    if(t.length!==5){out.push(`${line} â†’ æ ¼å¼éŒ¯èª¤`);continue;}
    let s=1; t.forEach(n=>s*=probs[n-1]);
    out.push(`${line} â†’ ${(s*100).toFixed(6)}%`);
  }
  myres.textContent=out.join("\n");

  // 4. å›æ¸¬
  const rows=backtest(all);
  renderHits(rows);

  // 5. æ›´æ–°åœ–è¡¨
  drawStreakChart(all);
  drawCountChart(all);
}

async function generateModelFiles() {
  // å»ºæ§‹ C å‹æ¨¡å‹
  const model = tf.sequential();
  model.add(tf.layers.dense({ units: 512, activation: "relu", inputShape: [39 * 20] }));
  model.add(tf.layers.dense({ units: 256, activation: "relu" }));
  model.add(tf.layers.dense({ units: 128, activation: "relu" }));
  model.add(tf.layers.dense({ units: 64,  activation: "relu" }));
  model.add(tf.layers.dense({ units: 39,  activation: "softmax" }));

  model.compile({
    optimizer: tf.train.adam(0.001),
    loss: "categoricalCrossentropy"
  });

  // è®“æ¬Šé‡åˆå§‹åŒ–ï¼ˆé‡é»ï¼ï¼‰
  // å»ºä¸€å€‹å‡çš„è¼¸å…¥ä¸Ÿé€²å»ä¸€æ¬¡
  const dummy = tf.zeros([1, 39 * 20]);
  model.predict(dummy);

  // å­˜åˆ°æœ¬æ©Ÿ â†’ æœƒè‡ªå‹•ä¸‹è¼‰ model.json + weights.bin
  await model.save("downloads://539-ai-model");

  alert("ğŸ‰ AI æ¨¡å‹å·²ç”¢ç”Ÿï¼è«‹æŸ¥çœ‹ä¸‹è¼‰çš„ model.json èˆ‡ weights.bin");
}
</script>
</body>
</html>
