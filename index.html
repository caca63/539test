<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>å°ç£ 539 AI æ©Ÿç‡åˆ†æå™¨ v3</title>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  margin:0;
  padding:16px;
}
.card{
  background:#111827cc;
  padding:14px;
  border-radius:16px;
  margin-bottom:12px;
  box-shadow:0 10px 25px rgba(15,23,42,.6);
}
.btn{
  padding:8px 12px;
  border-radius:999px;
  border:0;
  background:linear-gradient(135deg,#22d3ee,#60a5fa);
  color:#020617;
  font-weight:700;
  cursor:pointer;
}
.btn.sec{
  background:#020617;
  color:#e5e7eb;
  border:1px solid rgba(148,163,184,.25);
}
input,textarea,select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.25);
  background:#020617;
  color:#e5e7eb;
}
.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
.split2{
  display:flex;
  gap:10px;
}
.split2>div{flex:1;}

.chip{
  background:#1e293b;
  border-radius:12px;
  padding:6px 8px;
  font-size:13px;
  border:1px solid rgba(148,163,184,.35);
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}
.chip.rankTop{
  border-color:#38bdf8;
  background:radial-gradient(circle at top,#0ea5e944,#020617);
}
.chartBox{
  width:100%;
  height:320px;
  background:#0b1120;
  border-radius:12px;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>å°ç£ 539 AI æ©Ÿç‡åˆ†æå™¨ v3</h1>

<div id="stats" style="margin-bottom:8px;color:#60a5fa"></div>

<!-- r è¡°æ¸› + è¨­å®š -->
<div class="card">
  <label>è¡°æ¸›æ¬Šé‡ r</label>
  <div class="row">
    <input id="r" type="number" step="0.01" min="0" max="1" value="0.8" style="max-width:100px">
    <button class="btn sec" onclick="setR(0.6)">r=0.6</button>
    <button class="btn sec" onclick="setR(0.8)">r=0.8</button>
    <button class="btn sec" onclick="setR(0.95)">r=0.95</button>
  </div>

  <div class="row">
    <label><input type="checkbox" id="streak" checked> ğŸ” ç†±è™Ÿé€£é–‹æ‡²ç½°</label>
    <label><input type="checkbox" id="avoid" checked> é¿å…é‡è¤‡ä¸Šä¸€æœŸ</label>
    <label><input type="checkbox" id="useAI" checked> ğŸ¤– ä½¿ç”¨ AIï¼ˆMarkov + TensorFlowï¼‰</label>
  </div>
</div>

<!-- æ–°å¢æœŸæ•¸ -->
<div class="card">
  <label>æ–°å¢æœ€æ–°ä¸€æœŸï¼ˆäº”é¡†ï¼‰</label>
  <input id="latest" placeholder="ä¾‹å¦‚ï¼š3 11 22 27 38">
  <div class="row">
    <button class="btn" onclick="appendLatest()">åŠ å…¥åˆ°æ­·å²</button>
    <button class="btn sec" onclick="clearAdded()">é‡ç½®æœ¬æ©Ÿæ–°å¢</button>
  </div>
</div>

<!-- å–®è™Ÿ AI æ©Ÿç‡ï¼ˆæ’åºï¼‰ -->
<div class="card">
  <h3>ğŸ”¢ å–®è™Ÿ AI æ©Ÿç‡ï¼ˆä¾æ¬Šé‡æ’åºï¼‰</h3>
  <div id="singleTop" class="split2" style="margin-top:6px;font-size:13px;color:#9ca3af">
    å°šæœªè¨ˆç®—
  </div>
</div>

<!-- Top10 -->
<div class="card">
  <h3>ğŸ’¡ æ¨è–¦çµ„åˆ Top10ï¼ˆAI + WebWorkerï¼‰</h3>
  <div id="toplist" class="split2"></div>

  <div class="row" style="margin-top:10px">
    <button class="btn" onclick="run()">ğŸ”¥ è¨ˆç®— AI é æ¸¬</button>
  </div>
</div>

<div class="card">
  <h3>ğŸ¤– ç”¢ç”Ÿ AI æ¨¡å‹ï¼ˆmodel.json + weights.binï¼‰</h3>
  <button class="btn" onclick="generateModelFiles()">
    ç”¢ç”Ÿ AI æ¨¡å‹ï¼ˆGlorot åˆå§‹åŒ–ï¼‰
  </button>
  <div style="font-size:12px;color:#94a3b8;margin-top:6px;">
    æŒ‰ä¸‹å¾Œï¼Œç€è¦½å™¨æœƒè‡ªå‹•ä¸‹è¼‰ model.json èˆ‡ weights.binã€‚
  </div>
</div>

<!-- æˆ‘çš„ä¸‹æ³¨ -->
<div class="card">
  <h3>æˆ‘çš„ä¸‹æ³¨çµæœ</h3>
  <textarea id="bets" placeholder="ä¾‹å¦‚ï¼š1 12 23 28 35"></textarea>
  <div id="myres" style="white-space:pre-wrap;margin-top:10px;color:#94a3b8">å°šæœªè¨ˆç®—</div>
</div>

<!-- åœ–è¡¨ -->
<div class="card">
  <h3>ğŸ“ˆ é€£èŠèµ°å‹¢åœ–ï¼ˆèˆ‡å‰ä¸€æœŸé‡è¤‡çš„è™Ÿç¢¼æ•¸ï¼‰</h3>
  <canvas id="streakChart" height="180"></canvas>
</div>

<div class="card">
  <h3>ğŸ“Š å„è™Ÿç¢¼å‡ºç¾æ¬¡æ•¸çµ±è¨ˆï¼ˆ1~39ï¼‰</h3>
  <canvas id="countChart" height="220"></canvas>
</div>

<!-- å›æ¸¬ -->
<div class="card">
  <h3>ğŸ“ˆ å›æ¸¬ï¼ˆTop5ï¼‰</h3>
  <div id="hitSummary" style="margin-bottom:8px;color:#94a3b8">å°šæœªå›æ¸¬</div>
  <table style="width:100%;font-size:12px;border-collapse:collapse;">
    <thead>
      <tr style="color:#bfdbfe">
        <th>æœŸæ•¸</th><th>é–‹ç</th><th>æœ€ä½³</th><th>å‘½ä¸­çµ„åˆ</th>
      </tr>
    </thead>
    <tbody id="hitTable"></tbody>
  </table>
</div>

<script src="issueDate.js"></script>
<script src="fetchData.js"></script>
<script src="charts.js"></script>
<script src="ai.js"></script>

<script>
// ------------------ Data ----------------------
const LS_KEY = "extra539_v3";
let added = JSON.parse(localStorage.getItem(LS_KEY) || "[]");

// âœ… é€™è£¡è²¼ã€Œä½ å‰›å‰›é‚£ä¸€å¤§ä¸²ã€å¾ 11/14 åˆ° 01/01 çš„åŸå§‹æ–‡å­—ï¼ˆä¸ç”¨æ”¹æ ¼å¼ï¼‰
const RAW_HISTORY = `
[
[2,7,8,10,14],
[8,9,12,21,23],
[7,21,22,27,35],
[13,23,27,31,37],
[12,18,20,24,31],
[2,8,19,21,29],
[9,11,15,18,20],
[5,12,13,19,34],
[4,12,28,35,38],
[10,22,31,35,36],
[3,21,22,26,39],
[9,13,23,29,34],
[4,7,8,24,26],
[7,12,18,35,39],
[3,12,19,32,34],
[1,14,18,19,22],
[6,19,23,26,30],
[4,7,17,22,35],
[5,9,12,14,31],
[1,7,32,36,37],
[7,8,9,17,20],
[1,6,16,26,31],
[13,22,23,24,35],
[4,11,25,31,32],
[9,11,14,18,27],
[1,5,9,14,26],
[1,10,23,32,37],
[9,16,29,32,39],
[4,16,21,23,37],
[1,8,16,19,31],
[6,7,8,14,39],
[3,7,22,29,34],
[16,21,26,29,37],
[8,24,28,37,38],
[4,5,27,35,37],
[12,22,26,28,35],
[10,18,19,27,28],
[2,6,19,28,29],
[2,7,11,20,30],
[11,17,29,34,39],
[6,8,10,21,26],
[9,15,29,30,39],
[10,12,13,19,33],
[3,27,28,33,38],
[3,7,17,24,27],
[11,13,18,30,35],
[4,7,11,19,22],
[8,17,18,24,36],
[5,11,26,33,35],
[3,11,24,27,36],
[11,12,20,28,29],
[5,27,31,38,39],
[4,16,29,31,34],
[8,9,12,22,27],
[11,18,21,23,36],
[15,23,29,36,39],
[8,12,15,18,34],
[9,10,19,33,35],
[17,23,24,27,35],
[2,4,7,25,37],
[2,21,24,27,31],
[6,14,27,30,33],
[3,4,7,11,30],
[6,8,18,19,28],
[8,15,25,26,34],
[7,11,13,26,30],
[3,13,15,19,25],
[11,15,25,29,34],
[2,16,17,27,32],
[5,9,15,20,26],
[5,13,16,24,28],
[7,25,32,34,35],
[4,20,24,27,38],
[1,10,12,32,35],
[5,25,33,36,37],
[13,24,25,36,39],
[4,9,12,17,27],
[7,10,13,23,26],
[5,13,17,19,31],
[4,8,29,32,34],
[5,16,23,31,39],
[3,6,7,36,38],
[12,13,14,15,24],
[1,6,19,26,33],
[6,17,18,19,32],
[4,6,14,24,35],
[14,19,22,26,28],
[15,17,26,27,35],
[9,11,15,25,31],
[9,10,22,30,33],
[2,3,16,27,39],
[7,22,25,29,38],
[3,6,23,24,37],
[7,24,28,31,36],
[14,19,21,26,36],
[2,6,12,14,24],
[8,19,23,27,31],
[1,16,19,27,33],
[4,6,25,29,35],
[1,5,24,33,36],
[20,23,32,35,38],
[6,12,17,38,39],
[1,7,13,18,35],
[22,26,30,31,38],
[8,19,25,27,39],
[5,12,20,24,28],
[1,10,19,27,31],
[4,5,8,10,11],
[6,11,18,37,39],
[7,9,21,28,38],
[7,10,26,28,33],
[4,11,19,21,34],
[6,9,20,27,36],
[8,10,26,27,38],
[4,10,20,23,29],
[1,14,18,24,38],
[2,4,15,25,36],
[2,13,24,27,39],
[3,9,24,30,39],
[4,7,14,25,35],
[2,15,17,23,37],
[6,8,9,33,36],
[2,12,14,26,37],
[7,12,23,26,36],
[12,14,15,17,24],
[2,5,8,17,24],
[3,8,15,24,39],
[3,14,22,31,38],
[1,10,12,20,31],
[2,11,28,30,37],
[1,6,13,24,29],
[3,4,10,19,37],
[12,22,29,33,34],
[7,8,11,23,31],
[6,8,11,19,38],
[6,13,21,24,38],
[10,21,22,26,27],
[15,18,24,31,32],
[4,6,11,29,37],
[12,21,22,38,39],
[7,11,14,26,27],
[1,6,11,22,34],
[19,21,27,32,39],
[16,18,23,36,39],
[2,6,9,29,32],
[5,7,10,26,30],
[14,15,18,23,29],
[4,16,22,23,30],
[1,6,10,13,27],
[17,22,24,30,32],
[11,12,17,34,36],
[2,13,18,33,34],
[3,14,22,25,31],
[3,21,23,25,26],
[13,20,21,32,37],
[6,10,24,28,38],
[10,20,28,30,37],
[11,25,27,30,34],
[1,9,27,29,30],
[1,14,22,26,28],
[1,9,17,25,30],
[11,23,26,32,34],
[10,12,14,31,35],
[1,5,16,18,26],
[15,18,22,24,31],
[9,12,18,27,29],
[6,7,18,31,35],
[15,18,29,31,39],
[16,27,28,29,33],
[6,7,21,37,38],
[4,5,8,27,39],
[6,12,15,23,26],
[2,5,24,38,39],
[3,5,28,30,32],
[5,7,21,23,29],
[7,20,21,30,38],
[4,5,7,13,14],
[21,24,28,29,35],
[5,8,10,23,25],
[14,15,20,21,23],
[6,7,24,27,34],
[7,9,29,32,38],
[8,14,25,28,31],
[7,11,20,28,38],
[8,20,23,25,26],
[12,14,16,28,39],
[6,18,26,28,36],
[9,12,16,26,34],
[2,25,32,35,36],
[7,9,10,12,28],
[2,9,19,21,33],
[4,6,7,12,38],
[5,12,14,23,33],
[2,11,22,24,31],
[5,8,11,13,22],
[7,9,12,14,33],
[6,19,20,33,37],
[4,22,23,35,39],
[2,10,13,28,32],
[3,7,14,25,34],
[3,11,13,28,37],
[3,15,21,29,37],
[14,20,21,28,33],
[3,5,12,22,27],
[10,19,25,36,39],
[10,16,19,21,28],
[3,4,10,18,39],
[3,5,6,12,13],
[1,16,20,28,34],
[3,9,26,38,39],
[2,4,12,15,29],
[3,6,24,31,36],
[4,9,19,22,34],
[8,13,14,22,36],
[4,5,9,18,24],
[4,7,19,33,39],
[4,18,21,30,37],
[1,21,31,32,34],
[2,17,32,35,38],
[6,13,22,23,27],
[13,22,30,37,38],
[3,4,20,25,28],
[8,15,27,37,38],
[8,11,13,37,38],
[3,4,11,21,34],
[3,20,26,31,37],
[18,20,25,29,31],
[26,32,33,36,39],
[5,27,28,31,37],
[11,18,25,26,33],
[8,12,19,27,28],
[24,25,34,36,37],
[1,7,12,29,39],
[11,14,15,27,39],
[7,24,28,31,32],
[22,27,30,32,37],
[7,8,9,26,34],
[7,14,15,17,30],
[5,19,31,34,39],
[1,4,9,14,22],
[13,18,20,23,36],
[2,11,15,37,38]
]
`;

function parseRawHistory(raw) {
  try {
    const arr = JSON.parse(raw);

    const cleaned = arr.filter(
      x => Array.isArray(x) && x.length === 5
    );

    // RAW_HISTORY æ˜¯ã€Œæœ€æ–° â†’ æœ€èˆŠã€
    // AI è¦ã€Œæœ€èˆŠ â†’ æœ€æ–°ã€
    return cleaned.reverse();

  } catch (e) {
    console.error("RAW_HISTORY JSON æ ¼å¼ä¸æ­£ç¢º", e);
    return [];
  }
}

let baseHistory = parseRawHistory(RAW_HISTORY);

function getAll() {
  return baseHistory.concat(added);
}

function updateStats() {
  const all = getAll();
  const latest = all[all.length - 1] || [];
  document.getElementById("stats").innerHTML =
    `ğŸ“Š æ­·å²æœŸæ•¸ï¼š${all.length}ã€€æœ€æ–°ï¼š${latest.join(" ")}`;
}
updateStats();

function appendLatest() {
  const v = latest.value.trim().split(/\s+/).map(Number);
  if (v.length === 5 && v.every(n => n >= 1 && n <= 39)) {
    added.push(v);
    localStorage.setItem(LS_KEY, JSON.stringify(added));
    updateStats();
    latest.value = "";
  } else alert("äº”é¡† 1~39");
}

function clearAdded() {
  if (confirm("æ¸…é™¤æœ¬æ©Ÿæ–°å¢ï¼Ÿ")) {
    added = [];
    localStorage.removeItem(LS_KEY);
    updateStats();
  }
}

function setR(v) { document.getElementById("r").value = v; }

// ------------------ WebWorker ----------------------
const worker=new Worker("worker.js");
let workerReady=false;

worker.onmessage=function(e){
  const msg=e.data;

  if(msg.type==="ready"){
    workerReady=true;
    return;
  }
  if(msg.type==="top10"){
    renderTop10(msg.data);
    return;
  }
};

function computeTop10(probs,last,avoid,streak){
  if(!workerReady){
    alert("Worker å°šæœªè¼‰å…¥å®Œç•¢ï¼");
    return;
  }
  worker.postMessage({
    type:"computeTop10",
    probs,last,avoid,streak
  });
}


// ------------------ å–®è™Ÿæ’åº ----------------------
function updateSingleTop(probs){
  const arr=probs.map((p,i)=>({num:i+1,p})).sort((a,b)=>b.p-a.p);

  const left=arr.slice(0,20);
  const right=arr.slice(20);

  singleTop.innerHTML=`
    <div>${left.map(o=>`<div class="chip"><span>${o.num}</span><span>${(o.p*100).toFixed(3)}%</span></div>`).join("")}</div>
    <div>${right.map(o=>`<div class="chip"><span>${o.num}</span><span>${(o.p*100).toFixed(3)}%</span></div>`).join("")}</div>
  `;
}


// ------------------ Top10 ----------------------
function renderTop10(list){
  const left=list.slice(0,5);
  const right=list.slice(5);

  toplist.innerHTML=`
    <div>${left.map((o,i)=>`
      <div class="chip rankTop">
        <span>Top${i+1}ï½œ${o.t.join(" ")}</span>
        <span>${(o.score*100).toFixed(6)}%</span>
      </div>`).join("")}</div>

    <div>${right.map((o,i)=>`
      <div class="chip">
        <span>Top${i+6}ï½œ${o.t.join(" ")}</span>
        <span>${(o.score*100).toFixed(6)}%</span>
      </div>`).join("")}</div>
  `;
}


// ------------------ å›æ¸¬ï¼ˆä¿®æ­£ç‰ˆï¼‰ ----------------------
async function backtest(all){
  const rows=[];
  const streak = document.getElementById("streak").checked;
  const avoid = document.getElementById("avoid").checked;

  for(let i=1;i<all.length-1;i++){
    const train = all.slice(0,i+1);
    const target = all[i+1];

    // ğŸ”¥ğŸ”¥ é—œéµä¿®æ­£ï¼šè¦ await æ‰èƒ½å¾—åˆ° 39 å€‹æ©Ÿç‡
    const probs = await window.AI_finalProb(train);

    const last = train[train.length-1];

    // Top5ï¼ˆæœ¬åœ°é‹ç®—ç‰ˆï¼‰
    const top5 = window.AI_localComputeTop5(probs,last,avoid,streak);

    let best = 0;
    const hitList = [];
    for(const t of top5){
      const hit = t.t.filter(x=>target.includes(x)).length;
      if(hit>0) hitList.push({t:t.t, hit});
      best = Math.max(best, hit);
    }

    rows.push({issue:i+1, target, best, hitList});
  }
  return rows;
}

function renderHits(rows){
  let html="";
  let c1=0,c2=0,c3=0,c4=0,c5=0;

  for(const r of rows){
    if(r.best===1)c1++;
    if(r.best===2)c2++;
    if(r.best===3)c3++;
    if(r.best===4)c4++;
    if(r.best===5)c5++;

    html+=`
      <tr>
        <td>${r.issue}</td>
        <td>${r.target.join(" ")}</td>
        <td>${r.best}</td>
        <td>${r.hitList.map(x=>`${x.t.join(" ")}(${x.hit})`).join("ã€") || "-"}</td>
      </tr>`;
  }
  hitTable.innerHTML=html;

  hitSummary.innerHTML=
    `è‡³å°‘ä¸­ 1 é¡†ï¼š${c1+c2+c3+c4+c5} æœŸï¼ˆå«å…¨ä¸­ ${c5} æœŸï¼‰`;
}


// ------------------ ä¸»æµç¨‹ï¼ˆæœ€ä½³ç‰ˆï¼‰ ----------------------
async function run(){
  const all = getAll();
  if (!all || !all.length){
    alert("æ­·å²è³‡æ–™ç‚ºç©ºï¼Œè«‹å…ˆç¢ºèª RAW_HISTORY æ˜¯å¦æ­£ç¢ºã€‚");
    return;
  }

  // å˜—è©¦æŠ“æŒ‰éˆ•ä¾†åš Loading ç‹€æ…‹ï¼ˆå¦‚æœæ²’æŠ“åˆ°ä¹Ÿæ²’é—œä¿‚ï¼‰
  const btn = document.querySelector('button[onclick="run()"]');
  const oldBtnText = btn ? btn.textContent : "";
  if (btn){
    btn.disabled = true;
    btn.textContent = "è¨ˆç®—ä¸­...";
  }

  // é¡¯ç¤ºè¨ˆç®—ä¸­ç‹€æ…‹
  singleTop.innerHTML = `<div>è¨ˆç®—ä¸­ï¼Œè«‹ç¨å€™...</div>`;
  toplist.innerHTML   = `<div>è¨ˆç®—ä¸­...</div>`;
  myres.textContent   = `è¨ˆç®—ä¸­...`;
  hitSummary.textContent = `å›æ¸¬è¨ˆç®—ä¸­...`;
  hitTable.innerHTML  = "";

  try{
    // 1ï¸âƒ£ å–®è™Ÿ AI æ©Ÿç‡ï¼ˆå…¨æ­·å²ï¼‰
    const probs = await AI_finalProb(all);
    if (!Array.isArray(probs) || probs.length !== 39){
      console.error("AI_finalProb å›å‚³æ ¼å¼ä¸æ­£ç¢ºï¼š", probs);
      alert("AI æ©Ÿç‡è¨ˆç®—çµæœç•°å¸¸ï¼Œè«‹æª¢æŸ¥ consoleã€‚");
      return;
    }
    updateSingleTop(probs);

    // 2ï¸âƒ£ Worker è¨ˆç®— Top10ï¼ˆç”¨æœ€å¾Œä¸€æœŸç•¶ã€Œä¸Šä¸€æœŸã€ï¼‰
    const lastDraw = all[all.length-1];
    computeTop10(
      probs,
      lastDraw,
      document.getElementById("avoid").checked,
      document.getElementById("streak").checked
    );

    // 3ï¸âƒ£ æˆ‘çš„ä¸‹æ³¨æ©Ÿç‡
    const betText = bets.value.trim();
    if (!betText){
      myres.textContent = "å°šæœªè¼¸å…¥ä¸‹æ³¨ã€‚";
    }else{
      const lines = betText.split(/\n+/).map(l=>l.trim()).filter(Boolean);
      const out = [];

      for (const line of lines){
        const t = line.split(/\s+/).map(Number).filter(n=>!isNaN(n));
        if (t.length !== 5){
          out.push(`${line} â†’ æ ¼å¼éŒ¯èª¤ï¼ˆéœ€è¦ 5 å€‹ 1~39 çš„æ•´æ•¸ï¼‰`);
          continue;
        }
        if (!t.every(n => n>=1 && n<=39)){
          out.push(`${line} â†’ è¶…å‡ºç¯„åœï¼ˆå¿…é ˆæ˜¯ 1~39ï¼‰`);
          continue;
        }
        let s = 1;
        t.forEach(n => { s *= probs[n-1]; });
        out.push(`${t.join(" ")} â†’ ${(s*100).toFixed(6)}%`);
      }
      myres.textContent = out.join("\n");
    }

    // 4ï¸âƒ£ å›æ¸¬ï¼ˆTop5ï¼‰
    const rows = await backtest(all);   // â† é€™è£¡ä¸€å®šè¦ await
    renderHits(rows);

    // 5ï¸âƒ£ æ›´æ–°åœ–è¡¨
    drawStreakChart(all);
    drawCountChart(all);

  }catch(err){
    console.error(err);
    alert("åŸ·è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é–‹ F12 â†’ Console æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯ã€‚");
  }finally{
    // é‚„åŸæŒ‰éˆ•ç‹€æ…‹
    if (btn){
      btn.disabled = false;
      btn.textContent = oldBtnText || "ğŸ”¥ è¨ˆç®— AI é æ¸¬";
    }
  }
}
</script>
</body>
</html>
